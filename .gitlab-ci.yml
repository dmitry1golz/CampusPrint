stages:
  - quality  # Code-Style (Java & Frontend)
  - test     # Schwere Integrationstests (DB)
  - build    # Artefakt bauen

# Globale Einstellungen
variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

# Cache für Speed (Maven & Node)
cache:
  paths:
    - .m2/repository
    - node_modules/

# ====================================================
# STAGE 1: QUALITY GATES (Laufen parallel)
# ====================================================

# 1.1 Java Formatierung prüfen (Spotless)
lint-backend:
  stage: quality
  image: maven:3.9.9-eclipse-temurin-21
  script:
    - echo "Prüfe Java Code Style mit Spotless..."
    - mvn spotless:check

  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
      allow_failure: true
    - if: $CI_COMMIT_MESSAGE =~ /\[TESTALL\]/
      allow_failure: true
  # Wenn Spotless meckert, bricht der Job ab -> Du musst lokal 'mvn spotless:apply' machen

# 1.2 Frontend Linting (TS, CSS, HTML)
lint-frontend:
  stage: quality
  image: node:22 # Node 22 ist LTS und aktuell
  script:
    - echo "Installiere Frontend-Dependencies..."
    - npm ci --cache .npm --prefer-offline
    - echo "Führe Linting durch..."
    - npm run lint:all
  
  artifacts:
    when: always
    reports:
      junit: 
        - reports/eslint.xml
        - reports/stylelint.xml
      # HTML Report
      codequality: reports/html.xml
    paths:
      - reports/

  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
      allow_failure: true
    - if: $CI_COMMIT_MESSAGE =~ /\[TESTALL\]/
      allow_failure: true

# ====================================================
# STAGE 2: DATABASE TESTS (Testcontainers)
# ====================================================
database-integration-tests:
  stage: test
  # Wir bleiben beim funktionierenden Java 21 Image
  image: maven:3.9.9-eclipse-temurin-21
  
  services:
    # Wir pinnen eine stabile dind Version und deaktivieren TLS explizit im Command
    - name: docker:27.4.1-dind
      alias: docker
      command: ["--tls=false"]
      
  variables:
    # WICHTIG: Testcontainers sagen, wo Docker läuft
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    # Optional: Ryuk deaktivieren, falls es Rechteprobleme gibt (meist nicht nötig, aber sicher ist sicher)
    # TESTCONTAINERS_RYUK_DISABLED: "true"
    
  script:
    - echo "Warte auf Docker Daemon..."
    # Hack: Maven startet oft zu schnell. Wir warten kurz, bis dind bereit ist.
    # Alternativ könnte man auf den Port pollen, aber sleep reicht meistens.
    - sleep 15 
    - echo "Starte Integrationstests..."
    - mvn test -Dtest=CampusPrintDatabaseTests
    
  artifacts:
    when: always
    reports:
      # KORREKTUR: Maven Surefire speichert Reports standardmäßig hier:
      junit: target/Database-*.xml
    paths:
      # Damit du die HTML/XML Dateien auch im Browser in GitLab anschauen kannst
      - target/
  # Deine Regel: Läuft nur, wenn [DatabaseTest] in der Commit-Message steht
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[DatabaseTest\]/
    # Optional: Läuft auch automatisch auf dem main branch (empfohlen)
    #- if: $CI_COMMIT_BRANCH == "main"
    #  when: always
    - if: $CI_COMMIT_MESSAGE =~ /\[TESTALL\]/
      allow_failure: false

controller-tests:
  stage: test
  image: maven:3.9.9-eclipse-temurin-21
  script:
    - echo "Führe schnelle Unit-Tests aus (inkl. Controller Tests)..."
    - mvn test -Dtest=DeviceControllerTest
    # add other controller tests here
  
  artifacts:
    when: always
    reports:
      junit: 
        - reports/Controller-*.xml
    expire_in: 1 week
    paths:
      # Damit du die HTML/XML Dateien auch im Browser in GitLab anschauen kannst
      - target/

  # Optional: Nur laufen lassen, wenn du es willst (oder Magic Commit)
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[controller\]/
      allow_failure: false
    - if: $CI_COMMIT_MESSAGE =~ /\[TESTALL\]/
      allow_failure: false

# ====================================================
# STAGE 3: BUILD
# ====================================================
build-jar:
  stage: build
  image: maven:3.9.9-eclipse-temurin-21
  # Startet erst, wenn Quality OK ist. 
  # DB-Tests sind optional (wegen der rules oben), daher warten wir nicht zwingend drauf, 
  # es sei denn sie laufen.
  needs: ["lint-backend", "lint-frontend"] 
  
  script:
    - echo "Baue die Anwendung..."
    - mvn package -DskipTests
    
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 week

  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always