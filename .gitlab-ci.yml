stages:
  - quality  # Code-Style (Java & Frontend)
  - test     # Schwere Integrationstests (DB)
  - build    # Artefakt bauen

# Globale Einstellungen
variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

# Cache für Speed (Maven & Node)
cache:
  paths:
    - .m2/repository
    - node_modules/

# ====================================================
# STAGE 1: QUALITY GATES (Laufen parallel)
# ====================================================

# 1.1 Java Formatierung prüfen (Spotless)
lint-backend:
  stage: quality
  image: maven:latest
  script:
    - echo "Prüfe Java Code Style mit Spotless..."
    - mvn spotless:check

  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
      allow_failure: true
    - if: $CI_COMMIT_MESSAGE =~ /\[TESTALL\]/
      allow_failure: true
  # Wenn Spotless meckert, bricht der Job ab -> Du musst lokal 'mvn spotless:apply' machen

# 1.2 Frontend Linting (TS, CSS, HTML)
lint-frontend:
  stage: quality
  image: node:22 # Node 22 ist LTS und aktuell
  script:
    - echo "Installiere Frontend-Dependencies..."
    - npm ci --cache .npm --prefer-offline
    - echo "Führe Linting durch..."
    - npm run lint:all
  
  artifacts:
    when: always
    reports:
      junit: 
        - reports/eslint.xml
        - reports/stylelint.xml
      # HTML Report
      codequality: reports/html.xml
    paths:
      - reports/

  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
      allow_failure: true
    - if: $CI_COMMIT_MESSAGE =~ /\[TESTALL\]/
      allow_failure: true

# ====================================================
# STAGE 2: DATABASE TESTS (Testcontainers)
# ====================================================
database-integration-tests:
  stage: test
  image: maven:latest
  
  # Docker-in-Docker für Testcontainers
  services:
    - name: docker:dind
      alias: docker
      
  variables:
    DOCKER_HOST: tcp://docker:2375 
    DOCKER_TLS_CERTDIR: ""
    
  script:
    - echo "Starte Integrationstests..."
    # KORREKTUR: "test" Goal hinzugefügt
    - mvn test -Dtest=CampusPrintDatabaseTests
    
  artifacts:
    when: always
    reports:
      junit: reports/Database-*.xml

  # Deine Regel: Läuft nur, wenn [DatabaseTest] in der Commit-Message steht
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[DatabaseTest\]/
    # Optional: Läuft auch automatisch auf dem main branch (empfohlen)
    #- if: $CI_COMMIT_BRANCH == "main"
    #  when: always
    - if: $CI_COMMIT_MESSAGE =~ /\[TESTALL\]/
      allow_failure: false

controller-tests:
  stage: test
  image: maven:latest
  script:
    - echo "Führe schnelle Unit-Tests aus (inkl. Controller Tests)..."
    - mvn test -Dtest=DeviceControllerTest
    # add other controller tests here
  
  artifacts:
    when: always
    reports:
      junit: 
        - target/surefire-reports/TEST-*.xml
    expire_in: 1 week

  # Optional: Nur laufen lassen, wenn du es willst (oder Magic Commit)
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[controller\]/
      allow_failure: false
    - if: $CI_COMMIT_MESSAGE =~ /\[TESTALL\]/
      allow_failure: false

# ====================================================
# STAGE 3: BUILD
# ====================================================
build-jar:
  stage: build
  image: maven:latest
  # Startet erst, wenn Quality OK ist. 
  # DB-Tests sind optional (wegen der rules oben), daher warten wir nicht zwingend drauf, 
  # es sei denn sie laufen.
  needs: ["lint-backend", "lint-frontend"] 
  
  script:
    - echo "Baue die Anwendung..."
    - mvn package -DskipTests
    
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 week

  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always